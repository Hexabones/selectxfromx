"use strict";function Set(){var a={},b=0;this.insert=function(c){"object"!=typeof c&&(c=[c]);for(var d in c)a[c[d]]?a[c[d]]+=1:(a[c[d]]=1,b+=1);return this},this.count=function(c){return c?a[c]||0:b},this.includes=function(b){for(var c=0;c<b.length;c++)if(!a[b[c]])return!1;return!0},this.includedIn=function(a){var b=new Set(a);return b.includes(this.toArray())},this.toArray=function(){return Object.keys(a)};for(var c in arguments){var d=arguments[c];"object"!=typeof d&&(d=[d]);for(var e in d)this.insert(d[e])}}function Database(a){var b=10,c=10,d={};for(var e in a.data)d[a.data[e].type]=(d[a.data[e].type]||0)+1;this.findTypes=function(c){var e=[],f=c.toLowerCase();for(var g in d)(g.toLowerCase().search(f)>=0||0===f.length)&&a.types[g]&&e.push({score:c.length/g.length*d[g],data:a.types[g]});return e.sort(function(a,b){return b.score-a.score}),e.slice(0,b).map(function(a){return a.data})},this.select=function(b,c,d){"T"===c.state?d(this.findTypes(b)):"E"===c.state?"json"===a.types[c.type.name].source&&d(this.findEntitiesFromJson(b,c)):"D"===c.state&&"json"===a.types[c.type.name].source&&d(this.findEntitiesFromJson(b,c))},this.findEntitiesFromJson=function(d,e){var f=e.type.name,g=[],h=[],i={},j={},k={};for(var l in e.conditions)k[e.conditions[l].dimension+"="+e.conditions[l].value]=!0;a:for(var m in a.data){var n=a.data[m];if(n.type===f){b:for(var l in e.conditions){var o=e.conditions[l],p=n.characteristics[o.dimension];if(!p)continue a;"string"==typeof p&&(p=[p]);for(var q=0;q<p.length;q++)if(p[q]===o.value)continue b;continue a}if("E"===e.state){var r=this.matchScore(m,d);(r>0||0===d.length)&&g.push({score:r,data:{handle:m,key:m,description:"View"}});for(var s in n.characteristics){var r=this.matchScore(s,d);(r>0||0===d.length)&&(i[s]?(i[s].score+=r,i[s].data.objects.insert(m),i[s].data.values.insert(n.characteristics[s])):(i[s]={score:r,data:{handle:s,description:"Filter by "+s,kind:"dimension",dimension:s,objects:new Set(m),values:new Set(n.characteristics[s])}},h.push(i[s])))}}else{var p=n.characteristics[e.dimension];p?"string"==typeof p&&(p=[p]):p=[];for(var q=0;q<p.length;q++){var r=this.matchScore(p[q],d);if(r>0||0===d.length){var t=e.dimension+"="+p[q];k[t]||(j[t]?(j[t].score+=r,j[t].data.objects.insert(m)):(j[t]={score:r,data:{handle:"Filter by "+e.dimension,description:p[q],kind:"filter",dimension:e.dimension,value:p[q],objects:new Set(m)}},g.push(j[t])))}}}}}if("E"===e.state){var u={};for(var v in e.conditions)u[e.conditions[v].dimension]=(u[e.conditions[v].dimension]||new Set).insert(e.conditions[v].value);g.sort(function(a,b){return b.score-a.score}),g=g.slice(0,b);for(var w=g.map(function(a){return a.data.key}),x=0;x<h.length;x++){var y=h[x].data.objects.includedIn(w),s=h[x].data.dimension;!y&&u[s]&&(y=u[s].includes(h[x].data.values.toArray())),y||g.push(h[x]),h[x].data.valuesCount=h[x].data.values.count(),delete h[x].data.values,console.log("Filter on",h[x].data.dimension,y?"useless":"kept")}g.sort(function(a,b){return b.score-a.score})}return g=g.slice(0,b+c).map(function(a){return a.data.objects&&(a.data.count=a.data.objects.count(),delete a.data.objects),a.data}),console.log(g),g},this.matchScore=function(a,b){return a.toLowerCase().search(b.toLowerCase())>=0?b.length/a.length:0},this.find=function(c,d){var e=[],f=c.toLowerCase(),g={};a:for(var h in a.data){var i=a.data[h];if(i.type===d.type.name){for(var j in d.conditions){var k=d.conditions[j],l=i.characteristics[k.dimension];if(!l)continue a;"string"==typeof l&&(l=[l]);for(var m=!1,n=0;n<l.length;n++)if(l[n]===k.value){m=!0;break}if(!m)continue a}var o=0;h.toLowerCase().search(f)>=0&&(o+=f.length/h.length),(o>0||0===f.length)&&(i.handle||(i.handle=h),i.description||(i.description="View "+h),i.kind="entity",e.push({score:o,data:i}));for(var p in i.characteristics){var l=i.characteristics[p];"string"==typeof l&&(l=[l]);for(var n=0;n<l.length;n++){var q=l[n],o=0;if(q.toLowerCase().search(f)>=0&&(o+=f.length/q.length),o>0||0===f.length){var r=p+"="+q,s=g[r];s?s.score+=o:(s={score:o,data:{kind:"condition",handle:p,description:q,dimension:p,value:q}},g[r]=s,e.push(s))}}}}}return e.sort(function(a,b){return b.score-a.score}),e.slice(0,b).map(function(a){return a.data})}}angular.module("desktopApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("desktopApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("desktopApp").controller("SearchCtrl",["$scope","$http",function(a,b){var c=null;a.lucky=!0,a.query="",a.initialized=!1,a.filter={state:"T",type:null,conditions:[]},a.results=[],b.get("data/sample.json").success(function(b){c=new Database(b),a.initialized=!0,a.queryChanged()}),a.queryChanged=function(){a.initialized&&c.select(a.query,a.filter,function(b){a.results=b,a.focusedResultPosition=0,a.$$phase||a.$apply()})},a.focusedResult=function(){return a.results[a.focusedResultPosition]},a.focusedResultKind=function(){var b=a.focusedResult();return b?b.kind:null},a.keydown=function(b){if(9===b.keyCode||a.lucky&&32===b.keyCode){b.preventDefault();var c=a.focusedResult();c&&a.selectResult(c)}else 8===b.keyCode?0===a.query.length&&("D"===a.filter.state?(a.filter.state="E",a.filter.dimension=""):0===a.filter.conditions.length?(a.filter.state="T",a.filter.type=null):a.filter.conditions.splice(a.filter.conditions.length-1,1),a.queryChanged()):38===b.keyCode?(b.preventDefault(),a.focusedResultPosition--,a.focusedResultPosition<0&&(a.focusedResultPosition=a.results.length-1)):40===b.keyCode?(b.preventDefault(),a.focusedResultPosition++,a.focusedResultPosition>=a.results.length&&(a.focusedResultPosition=0)):console.log(b.keyCode)},a.selectResult=function(b){"type"===b.kind?(a.filter.type=b,a.filter.state="E",a.query="",a.queryChanged()):"dimension"===b.kind?(a.filter.state="D",a.filter.dimension=b.dimension,a.query="",a.queryChanged()):"filter"===b.kind&&(a.filter.conditions.push({dimension:b.dimension,value:b.value}),a.filter.state="E",a.filter.dimension="",a.query="",a.queryChanged())}}]);