"use strict";function Database(a){var b=10,c={};for(var d in a.data)c[a.data[d].type]=(c[a.data[d].type]||0)+1;this.findTypes=function(d){var e=[],f=d.toLowerCase();for(var g in c)(g.toLowerCase().search(f)>=0||0===f.length)&&a.types[g]&&e.push({score:d.length/g.length*c[g],data:a.types[g]});return e.sort(function(a,b){return b.score-a.score}),e.slice(0,b).map(function(a){return a.data})},this.select=function(b,c,d){"T"===c.state?d(this.findTypes(b)):"E"===c.state?"json"===a.types[c.type.name].source&&d(this.findEntitiesFromJson(b,c)):"D"===c.state&&"json"===a.types[c.type.name].source&&d(this.findEntitiesFromJson(b,c))},this.findEntitiesFromJson=function(c,d){var e=d.type.name,f=[],g={},h={};a:for(var i in a.data){var j=a.data[i];if(j.type===e){b:for(var k in d.conditions){var l=d.conditions[k],m=j.characteristics[l.dimension];if(!m)continue a;"string"==typeof m&&(m=[m]);for(var n=0;n<m.length;n++)if(m[n]===l.value)continue b;continue a}if("E"===d.state){var o=this.matchScore(i,c);(o>0||0===c.length)&&f.push({score:o,data:{handle:i,description:"View"}});for(var p in j.characteristics){var o=this.matchScore(p,c);(o>0||0===c.length)&&(g[p]?g[p].score+=o:(g[p]={score:o,data:{handle:p,description:"Filter by "+p,kind:"dimension",dimension:p}},f.push(g[p])))}}else{var m=j.characteristics[d.dimension];m?"string"==typeof m&&(m=[m]):m=[];for(var n=0;n<m.length;n++){var o=this.matchScore(m[n],c);if(o>0||0===c.length){var q=d.dimension+"="+m[n];h[q]?h[q].score+=o:(h[q]={score:o,data:{handle:"Filter by "+d.dimension,description:m[n],kind:"filter",dimension:d.dimension,value:m[n]}},f.push(h[q]))}}}}}return f.sort(function(a,b){return b.score-a.score}),f.slice(0,b).map(function(a){return a.data})},this.matchScore=function(a,b){return a.toLowerCase().search(b.toLowerCase())>=0?b.length/a.length:0},this.find=function(c,d){var e=[],f=c.toLowerCase(),g={};a:for(var h in a.data){var i=a.data[h];if(i.type===d.type.name){for(var j in d.conditions){var k=d.conditions[j],l=i.characteristics[k.dimension];if(!l)continue a;"string"==typeof l&&(l=[l]);for(var m=!1,n=0;n<l.length;n++)if(l[n]===k.value){m=!0;break}if(!m)continue a}var o=0;h.toLowerCase().search(f)>=0&&(o+=f.length/h.length),(o>0||0===f.length)&&(i.handle||(i.handle=h),i.description||(i.description="View "+h),i.kind="entity",e.push({score:o,data:i}));for(var p in i.characteristics){var l=i.characteristics[p];"string"==typeof l&&(l=[l]);for(var n=0;n<l.length;n++){var q=l[n],o=0;if(q.toLowerCase().search(f)>=0&&(o+=f.length/q.length),o>0||0===f.length){var r=p+"="+q,s=g[r];s?s.score+=o:(s={score:o,data:{kind:"condition",handle:p,description:q,dimension:p,value:q}},g[r]=s,e.push(s))}}}}}return e.sort(function(a,b){return b.score-a.score}),e.slice(0,b).map(function(a){return a.data})}}angular.module("desktopApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("desktopApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("desktopApp").controller("SearchCtrl",["$scope","$http",function(a,b){var c=null;a.lucky=!0,a.query="",a.initialized=!1,a.filter={state:"T",type:null,conditions:[]},a.results=[],b.get("data/sample.json").success(function(b){c=new Database(b),a.initialized=!0,a.queryChanged()}),a.queryChanged=function(){a.initialized&&c.select(a.query,a.filter,function(b){a.results=b,a.focusedResultPosition=0,a.$$phase||a.$apply()})},a.focusedResult=function(){return a.results[a.focusedResultPosition]},a.focusedResultKind=function(){var b=a.focusedResult();return b?b.kind:null},a.keydown=function(b){if(9===b.keyCode||a.lucky&&32===b.keyCode){b.preventDefault();var c=a.focusedResult();c&&a.selectResult(c)}else 8===b.keyCode?0===a.query.length&&("D"===a.filter.state?(a.filter.state="E",a.filter.dimension=""):0===a.filter.conditions.length?(a.filter.state="T",a.filter.type=null):a.filter.conditions.splice(a.filter.conditions.length-1,1)):38===b.keyCode?(b.preventDefault(),a.focusedResultPosition--,a.focusedResultPosition<0&&(a.focusedResultPosition=a.results.length-1)):40===b.keyCode?(b.preventDefault(),a.focusedResultPosition++,a.focusedResultPosition>=a.results.length&&(a.focusedResultPosition=0)):console.log(b.keyCode)},a.selectResult=function(b){"type"===b.kind?(a.filter.type=b,a.filter.state="E",a.query="",a.queryChanged()):"dimension"===b.kind?(a.filter.state="D",a.filter.dimension=b.dimension,a.query="",a.queryChanged()):"filter"===b.kind&&(a.filter.conditions.push({dimension:b.dimension,value:b.value}),a.filter.state="E",a.filter.dimension="",a.query="",a.queryChanged())}}]);